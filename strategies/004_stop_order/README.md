# 止损订单策略

## 策略简介

本策略在经典双均线交叉策略基础上增加了自动止损功能。策略在金叉买入后自动设置止损单，当价格跌破止损位时自动平仓。同时，如果出现死叉信号，会先取消止损单再手动平仓。这种设计兼顾了趋势跟踪和风险控制。

## 策略原理

### 核心思想

止损订单策略解决了纯趋势跟踪策略在趋势反转时亏损过大的问题：
- **趋势入场**：使用双均线金叉作为入场信号，捕捉趋势起点
- **止损保护**：买入后立即设置止损单，限制单笔最大亏损
- **趋势出场**：死叉出现时主动平仓，锁定趋势收益

### 交易规则

**入场条件（开多仓）**：
- 短期均线从下方穿越长期均线（金叉）
- 使用当前可用资金的90%进行买入
- 买入后立即设置止损单

**止损设置**：
- 止损价格 = 买入价格 × (1 - 止损百分比)
- 默认止损比例为3%
- 止损单类型为Stop订单（触及止损价后变为市价单）

**出场条件（平多仓）**：
- 条件1：价格触及止损价，止损单自动执行
- 条件2：短期均线从上方穿越长期均线（死叉），此时先取消止损单再平仓

### 策略参数

| 参数名 | 类型 | 默认值 | 说明 |
|-------|-----|--------|------|
| short_period | int | 5 | 短期均线周期（日） |
| long_period | int | 20 | 长期均线周期（日） |
| stop_loss_pct | float | 0.03 | 止损百分比（3%） |

## 适用场景

1. **市场环境**：适合趋势明显但存在波动回调的市场
2. **品种选择**：适用于波动性适中的金融品种
3. **时间周期**：日线级别交易策略
4. **风险偏好**：适合对单笔亏损有严格控制的投资者

## 风险提示

1. **止损滑点**：止损单触发时可能存在滑点，实际亏损可能超过预期
2. **假突破**：价格可能短暂触及止损后恢复，造成不必要的亏损
3. **止损过近**：止损比例设置过小容易被正常波动触发
4. **缺口风险**：开盘跳空可能直接穿过止损价位
5. **死叉滞后**：死叉信号出现时可能已有较大回撤

## 回测示例

```python
import backtrader as bt

# 加载策略
from strategies.stop_order.strategy import StopOrderStrategy, ExtendPandasFeed

cerebro = bt.Cerebro()

# 加载数据
df = load_index_data('bond_index_000000.csv')
data = ExtendPandasFeed(dataname=df)
cerebro.adddata(data, name="bond_index")

# 设置初始资金和手续费
cerebro.broker.setcash(100000)
cerebro.broker.setcommission(commission=0.001)

# 添加策略
cerebro.addstrategy(StopOrderStrategy,
                    short_period=5,
                    long_period=20,
                    stop_loss_pct=0.03)

# 运行回测
results = cerebro.run()
```

## 参考资料

1. 止损订单类型和执行机制
2. 风险管理基础知识
3. 双均线交叉策略原理
