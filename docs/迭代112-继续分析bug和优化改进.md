### 背景
现有的功能已经基本实现，剩下的主要是对这些功能进行改进优化了；我希望能够把这个项目做成一个完善的世界一流的量化交易管理系统。

### 任务
1. 寻找并发现现有系统有哪些bug
2. 发现并寻找可以优化的地方
3. 把这些地方放到这个文档上线，方便后续进行改进优化.
4. 然后基于这些文档上的建议进行改进优化。

---

## 一、Bug 列表

### BUG-1: MemoryCache 使用类变量导致跨实例共享（严重）
- **文件**: `src/backend/app/db/cache.py:17`
- **问题**: `_cache: Dict[str, Dict[str, Any]] = {}` 定义为类变量而非实例变量，所有 `MemoryCache` 实例共享同一个字典。虽然当前通过单例模式 `get_cache()` 使用，但如果未来创建多个实例（如测试中），会产生数据污染。
- **修复**: 将 `_cache` 移到 `__init__` 中作为实例变量。

### BUG-2: MemoryCache 无过期清理机制（内存泄漏）
- **文件**: `src/backend/app/db/cache.py`
- **问题**: 过期条目只在被访问（`get`）时才被删除，长期运行后大量过期但未被访问的缓存条目会持续占用内存，导致内存泄漏。
- **修复**: 增加定期清理机制（如后台任务每隔 N 分钟清理过期条目），或设置最大缓存条目数。

### BUG-3: `datetime.utcnow()` 已弃用
- **文件**: `src/backend/app/models/backtest.py:25-26`, `user.py:21-22`, `strategy_service.py:185`
- **问题**: Python 3.12 中 `datetime.utcnow()` 已弃用，应使用 `datetime.now(timezone.utc)`。当前代码在多处使用了 `datetime.utcnow`。
- **修复**: 全局替换为 `datetime.now(timezone.utc)`。

### BUG-4: WebSocket URL 硬编码使用 `window.location.host`，开发环境下前后端端口不同
- **文件**: `src/frontend/src/views/BacktestPage.vue:294-295`
- **问题**: WebSocket URL 使用 `window.location.host` 构建，但开发环境中前端运行在 5173 端口，后端在 8000 端口，WebSocket 连接会失败。虽然有 `onerror` 回退到轮询，但这不是最优方案。
- **修复**: WebSocket URL 应通过 Vite 代理或环境变量配置，与 API baseURL 保持一致。

### BUG-5: `get_backtest_data` 中 analytics API 未校验用户归属
- **文件**: `src/backend/app/api/analytics.py:58-61`
- **问题**: `get_backtest_data()` 调用 `backtest_service.get_result(task_id)` 时未传入 `user_id`，意味着任何已登录用户都可以通过 task_id 查看其他用户的回测结果，存在数据越权风险。
- **修复**: 将 `current_user.sub` 传入 `get_result()` 的 `user_id` 参数。

### BUG-6: 贝叶斯优化中 `asyncio.run_coroutine_threadsafe` 使用错误
- **文件**: `src/backend/app/services/optimization_service.py:166-169`
- **问题**: `asyncio.get_event_loop()` 在 Optuna 的同步回调中调用时，可能获取到错误的事件循环（或没有运行中的循环），导致 `run_coroutine_threadsafe` 挂起或报错。这是一个已知的 asyncio 陷阱。
- **修复**: 应在启动优化前保存事件循环引用，或使用 `asyncio.run()` 在新线程中运行。

### BUG-7: `_run_single_backtest` 未等待回测完成就返回
- **文件**: `src/backend/app/services/optimization_service.py:231-248`
- **问题**: `_run_single_backtest` 调用 `run_backtest`（异步创建任务）后立即调用 `get_result`，但回测是异步执行的，此时结果可能还不存在，返回 `None`。
- **修复**: 应调用 `_wait_for_backtest` 等待回测完成后再获取结果。

### BUG-8: `list_results` 中 N+1 查询问题
- **文件**: `src/backend/app/services/backtest_service.py:426-431`
- **问题**: `list_results` 先查询任务列表，然后对每个任务调用 `get_result`（每次都会打开新的数据库会话），产生 N+1 查询问题，当回测历史较多时性能很差。
- **修复**: 使用 JOIN 查询一次性获取任务和结果，或使用 SQLAlchemy 的 `selectinload` 预加载关联。

### BUG-9: CSV 导出在交易记录为空时报错
- **文件**: `src/backend/app/api/analytics.py:397`
- **问题**: `trades[0].keys()` 在 `trades` 为空列表时会抛出 `IndexError`。
- **修复**: 添加空列表检查，返回空 CSV 或提示无数据。

### BUG-10: 前端 `toFixed()` 在数据为 undefined/null 时崩溃
- **文件**: `src/frontend/src/views/Dashboard.vue:34,47,113,119,124` 等多处
- **问题**: 多个页面直接对 `row.total_return.toFixed(2)` 等调用，如果后端返回的数据中某个字段为 `null` 或 `undefined`，前端会抛出 `TypeError`，导致页面白屏。
- **修复**: 使用安全访问 `(row.total_return ?? 0).toFixed(2)` 或封装工具函数。

### BUG-11: 前端登录后重定向可能存在 XSS 风险
- **文件**: `src/frontend/src/views/LoginPage.vue:99-100`
- **问题**: `route.query.redirect` 直接用于 `router.push(redirect || '/')`，如果攻击者构造恶意 URL（如 `?redirect=javascript:...` 或外部 URL），可能导致安全问题。
- **修复**: 验证 redirect 路径必须以 `/` 开头且不包含 `//`。

### BUG-12: `SQLRepository.update` 返回值使用了额外的数据库查询
- **文件**: `src/backend/app/db/sql_repository.py:40-49`
- **问题**: `update` 方法先执行 UPDATE 语句，commit 后再调用 `get_by_id` 获取更新后的实体，这意味着每次更新都需要两次数据库操作。
- **修复**: 可以在同一个 session 中使用 `session.get()` 或 `session.merge()` 来避免额外查询。

---

## 二、优化建议

### OPT-1: 策略模板只在启动时扫描一次，新增策略需重启
- **文件**: `src/backend/app/services/strategy_service.py:110`
- **问题**: `STRATEGY_TEMPLATES` 在模块加载时扫描一次，之后不再更新。如果用户新增了策略文件，需要重启服务才能生效。
- **优化**: 提供手动刷新 API 端点，或使用文件监听（watchdog）自动检测变化。

### OPT-2: 回测子进程的 stdout/stderr 未实时推送
- **文件**: `src/backend/app/services/backtest_service.py:297-311`
- **问题**: 使用 `proc.communicate()` 等待子进程完成，期间无法获取实时输出。回测进度条只有固定的 10%/20%/30%/80% 几个节点，用户体验不佳。
- **优化**: 使用 `proc.stdout.readline()` 逐行读取输出，解析进度信息并通过 WebSocket 实时推送。

### OPT-3: API 响应缺少统一的错误格式
- **文件**: 多个 API 文件
- **问题**: 错误响应格式不统一，有的返回 `{"detail": "..."}` (FastAPI 默认)，有的返回 `{"message": "..."}`。前端需要处理多种格式。
- **优化**: 创建统一的异常处理中间件，确保所有错误响应格式一致。

### OPT-4: 前端缺少全局加载状态和错误边界
- **文件**: 前端各页面
- **问题**: 每个页面独立管理 loading 状态，缺少全局的加载指示器和错误边界组件。页面切换时如果请求未完成，可能导致状态混乱。
- **优化**: 添加全局 loading bar（如 NProgress），添加 Vue ErrorBoundary 组件。

### OPT-5: 数据库连接池配置缺少 SQLite 特殊处理
- **文件**: `src/backend/app/db/database.py:12-16`
- **问题**: SQLite 不支持连接池的 `pool_pre_ping`，且 SQLite 的异步驱动 `aiosqlite` 在高并发下性能较差。当前配置未针对 SQLite 做特殊优化。
- **优化**: 对 SQLite 设置 `pool_size=1`，`connect_args={"check_same_thread": False}`。

### OPT-6: 前端 API 请求超时时间过短
- **文件**: `src/frontend/src/api/index.ts:8`
- **问题**: `timeout: 30000`（30秒），但回测任务可能需要数分钟。虽然回测本身是异步的，但某些分析 API（如 `get_backtest_data`）在解析大量日志时可能超时。
- **优化**: 对不同类型的请求设置不同的超时时间，或增加全局超时到 60 秒。

### OPT-7: 回测结果页面每次切换 Tab 都重新请求数据
- **文件**: `src/frontend/src/views/BacktestResultPage.vue:147-151`
- **问题**: `loadData` 同时请求 detail、kline、monthlyReturns 三个接口，但每个接口内部都调用 `get_backtest_data`，导致同一份数据被解析三次。
- **优化**: 后端提供一个聚合接口，一次返回所有分析数据；或在后端缓存 `get_backtest_data` 的结果。

### OPT-8: 缺少请求去重/防抖机制
- **文件**: 前端多个页面
- **问题**: 用户快速点击"运行回测"按钮可能触发多次请求。虽然有 `loading` 状态控制按钮禁用，但在网络延迟情况下仍可能重复提交。
- **优化**: 在 API 层添加请求去重逻辑，或使用防抖。

### OPT-9: 日志解析性能可优化
- **文件**: `src/backend/app/services/log_parser_service.py`
- **问题**: TSV 解析使用逐行 Python 字符串操作，对于大型日志文件（数万行）效率较低。
- **优化**: 使用 `pandas.read_csv(sep='\t')` 或 `csv.DictReader` 替代手动解析，性能可提升数倍。

### OPT-10: 前端 Markdown 渲染使用正则替换，功能有限且不安全
- **文件**: `src/frontend/src/views/StrategyPage.vue:282-312`
- **问题**: 使用简单正则将 Markdown 转为 HTML，不支持链接、图片等常见语法，且 `v-html` 直接渲染可能存在 XSS 风险。
- **优化**: 使用 `marked` + `DOMPurify` 库进行安全的 Markdown 渲染。

### OPT-11: 缺少回测任务并发限制
- **文件**: `src/backend/app/services/backtest_service.py`
- **问题**: 没有限制单个用户或全局的并发回测任务数量。恶意用户可以同时提交大量回测任务，耗尽服务器资源。
- **优化**: 添加用户级和全局级的并发任务限制（如每用户最多 3 个并发任务）。

### OPT-12: 前端缺少 Token 过期自动刷新
- **文件**: `src/frontend/src/stores/auth.ts`, `src/frontend/src/api/index.ts`
- **问题**: JWT Token 过期后直接跳转登录页，用户体验差。Token 有效期 24 小时，但没有自动刷新机制。
- **优化**: 实现 Refresh Token 机制，或在 Token 即将过期时自动续期。

### OPT-13: Dashboard 统计数据仅基于当前页数据
- **文件**: `src/frontend/src/views/Dashboard.vue:189-205`
- **问题**: `fetchResults(5)` 只获取最近 5 条回测结果，但统计数据（平均收益率、最佳夏普比率）也基于这 5 条计算，不能反映全局情况。
- **优化**: 后端提供专门的统计 API，基于全量数据计算统计指标。

### OPT-14: 缺少数据库迁移工具
- **文件**: `src/backend/app/db/database.py:31-34`
- **问题**: 使用 `Base.metadata.create_all` 创建表，无法处理表结构变更（如新增列）。生产环境中数据库 schema 变更需要迁移工具。
- **优化**: 集成 Alembic 进行数据库迁移管理。

### OPT-15: 前端路由守卫中 `useAuthStore()` 可能在 Pinia 初始化前调用
- **文件**: `src/frontend/src/router/index.ts:84`
- **问题**: 路由守卫中直接调用 `useAuthStore()`，如果路由守卫在 Pinia 插件安装前执行，会报错。
- **优化**: 使用延迟初始化或在 `main.ts` 中确保 Pinia 先于 Router 安装。

### OPT-16: 后端 `lru_cache` 用于服务工厂函数可能导致内存泄漏
- **文件**: `src/backend/app/api/backtest.py:21-23`, `analytics.py:32-39`
- **问题**: `@lru_cache` 装饰的工厂函数会永久缓存服务实例，如果服务持有数据库连接或大量状态，可能导致资源泄漏。
- **优化**: 使用 FastAPI 的 `Depends` 配合生命周期管理，或使用 `@lru_cache(maxsize=1)`（当前已是默认行为，但应明确标注）。

### OPT-17: 前端 WebSocket 连接缺少心跳保活
- **文件**: `src/frontend/src/views/BacktestPage.vue:293-328`
- **问题**: WebSocket 连接建立后没有发送心跳包，长时间无数据传输时连接可能被中间代理（如 Nginx）断开。
- **优化**: 添加定时心跳（如每 30 秒发送 `ping`），后端已支持 `pong` 响应。

### OPT-18: 回测结果中 `equity_curve` 和 `trades` 存储在 JSON 列中，大数据量时查询慢
- **文件**: `src/backend/app/models/backtest.py:54-57`
- **问题**: 资金曲线和交易记录以 JSON 格式存储在单个列中，数据量大时（如数年日线数据 + 数千笔交易）会导致单行数据过大，查询和序列化变慢。
- **优化**: 考虑将资金曲线和交易记录拆分到独立的表中，或使用时序数据库存储。

---

## 三、改进优先级

### 高优先级（影响正确性和安全性）
1. **BUG-5**: analytics API 用户归属校验缺失（安全漏洞）
2. **BUG-9**: CSV 导出空列表 IndexError
3. **BUG-10**: 前端 toFixed() 空值崩溃
4. **BUG-11**: 登录重定向 XSS 风险
5. **OPT-11**: 回测任务并发限制

### 中优先级（影响性能和用户体验）
6. **BUG-1**: MemoryCache 类变量问题
7. **BUG-2**: MemoryCache 内存泄漏
8. **BUG-8**: N+1 查询问题
9. **OPT-7**: 回测分析数据重复解析
10. **OPT-4**: 全局加载状态和错误边界
11. **OPT-17**: WebSocket 心跳保活
12. **BUG-4**: WebSocket URL 开发环境问题

### 低优先级（代码质量和长期维护）
13. **BUG-3**: datetime.utcnow() 弃用
14. **OPT-1**: 策略模板热更新
15. **OPT-14**: 数据库迁移工具
16. **OPT-9**: 日志解析性能
17. **OPT-10**: Markdown 渲染安全性
18. **BUG-6/7**: 贝叶斯优化 asyncio 问题

---

## 四、已完成的修复

### ✅ BUG-5: analytics API 用户归属校验（已修复）
- **文件**: `src/backend/app/api/analytics.py`
- **修改**: `get_backtest_data()` 增加 `user_id` 参数，所有调用处传入 `current_user.sub`

### ✅ BUG-9: CSV 导出空列表 IndexError（已修复）
- **文件**: `src/backend/app/api/analytics.py`
- **修改**: 空 trades 时使用默认 fieldnames

### ✅ BUG-10: 前端 toFixed() 空值崩溃（已修复）
- **文件**: `src/frontend/src/views/Dashboard.vue`, `BacktestPage.vue`
- **修改**: 所有 `.toFixed()` 调用添加 `?? 0` 空值保护

### ✅ BUG-11: 登录重定向 XSS 风险（已修复）
- **文件**: `src/frontend/src/views/LoginPage.vue`
- **修改**: 验证 redirect 路径必须以 `/` 开头且不包含 `//`

### ✅ BUG-1: MemoryCache 类变量问题（已修复）
- **文件**: `src/backend/app/db/cache.py`
- **修改**: `_cache` 移至 `__init__` 实例变量

### ✅ BUG-2: MemoryCache 内存泄漏（已修复）
- **文件**: `src/backend/app/db/cache.py`
- **修改**: 增加定期清理机制（300秒间隔）+ 最大条目数限制（10000）

### ✅ BUG-3: datetime.utcnow() 弃用（已修复）
- **文件**: 所有 model 文件 + 所有 service 文件 + backtest_enhanced schema
- **修改**: 全局替换为 `datetime.now(timezone.utc)`

### ✅ BUG-4 + OPT-17: WebSocket 心跳保活（已修复）
- **文件**: `src/frontend/src/views/BacktestPage.vue`
- **修改**: 添加 30 秒心跳定时器，断开时清理

### ✅ OPT-11: 回测任务并发限制（已实现）
- **文件**: `src/backend/app/services/backtest_service.py`
- **修改**: 全局最大 10 个并发 + 每用户最大 3 个并发

### ✅ BUG-7: 优化服务 _run_single_backtest 未等待完成（已修复）
- **文件**: `src/backend/app/services/optimization_service.py`
- **修改**: 改用 `_wait_for_backtest` 等待回测完成

### 🔲 待后续处理
- **BUG-6**: 贝叶斯优化 asyncio 事件循环问题（需要更大范围重构）
- **BUG-8**: N+1 查询问题（需要重构 SQLRepository）
- **BUG-12**: SQLRepository.update 额外查询（需要重构）
- **OPT-1 ~ OPT-18**: 其余优化项（按需逐步实施）