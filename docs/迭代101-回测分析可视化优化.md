# 迭代101 - 回测分析可视化优化

## 1. 迭代概述

### 1.1 背景
当前 backtrader_web 的回测分析展示效果较为简单，仅包含基础的资金曲线图表。参考 `stock-backtrader-web-app` 项目的实现，需要对回测分析页面进行全面优化，提供更专业、更丰富的可视化展示。

### 1.2 目标
- 提供专业级的回测结果可视化
- 支持交互式K线图与买卖点标记
- 展示详细的绩效指标面板
- 支持交易记录明细查看
- 提供参数优化结果对比
- 支持多时间周期切换

### 1.3 参考项目
- `stock-backtrader-web-app/web/stockpage.py` - RSI策略回测展示
- `stock-backtrader-web-app/internal/pkg/charts/` - 图表绘制模块
- `stock-backtrader-web-app/core/contract/drawer.py` - Plotly交互式图表

---

## 2. 需求规格说明

### 2.1 功能需求

#### 2.1.1 绩效指标面板 (Performance Metrics Panel)

**需求描述**: 在回测结果页面顶部展示关键绩效指标卡片

**指标列表**:
| 指标名称 | 英文名 | 计算说明 |
|---------|--------|---------|
| 初始资金 | Initial Capital | 回测起始资金 |
| 最终资产 | Final Assets | 回测结束时总资产 |
| 总收益率 | Total Return | (最终资产-初始资金)/初始资金 |
| 年化收益率 | Annualized Return | (1+总收益率)^(252/交易日数)-1 |
| 最大回撤 | Max Drawdown | 最大净值回撤百分比 |
| 夏普比率 | Sharpe Ratio | 风险调整后收益 |
| 胜率 | Win Rate | 盈利交易数/总交易数 |
| 盈亏比 | Profit Factor | 总盈利/总亏损 |
| 交易次数 | Trade Count | 总买卖交易次数 |
| 持仓天数 | Holding Days | 平均持仓天数 |

**UI设计**:
```
┌─────────────┬─────────────┬─────────────┬─────────────┐
│  初始资金   │  最终资产   │  总收益率   │  年化收益   │
│  ¥100,000  │  ¥125,000  │   +25.00%   │   +18.5%   │
│            │    ↑25%    │             │             │
└─────────────┴─────────────┴─────────────┴─────────────┘
┌─────────────┬─────────────┬─────────────┬─────────────┐
│  最大回撤   │  夏普比率   │    胜率     │  交易次数   │
│   -12.5%   │    1.85    │   58.3%    │     24     │
└─────────────┴─────────────┴─────────────┴─────────────┘
```

#### 2.1.2 交互式K线图 (Interactive Candlestick Chart)

**需求描述**: 展示带有买卖点标记的专业K线图

**功能要求**:
- 支持蜡烛图(Candlestick)展示OHLC数据
- 叠加MA5/MA10/MA20/MA60均线
- 底部显示成交量柱状图（红涨绿跌）
- 在K线上标记买入点(红色向上箭头)和卖出点(绿色向下箭头)
- 支持缩放、平移、十字光标
- 支持时间范围快速选择(1月/3月/6月/1年/全部)
- 悬停显示详细数据(日期、开高低收、成交量、涨跌幅)

**技术方案**:
- 前端: 使用 ECharts 或 Plotly.js
- 后端: 返回标准化的K线数据和交易信号数据

#### 2.1.3 资金曲线图 (Equity Curve Chart)

**需求描述**: 展示资金变化和回撤情况

**功能要求**:
- 主图: 总资产曲线、现金曲线、持仓市值曲线
- 副图: 回撤曲线(负值区域填充)
- 支持与基准(如沪深300)对比
- 高亮最大回撤区间
- 显示收益率的时间分布

**图表布局**:
```
┌────────────────────────────────────────────┐
│                 资金曲线                    │
│  ───── 总资产  ----- 现金  ····· 持仓市值   │
│                                            │
│     ╱╲                                     │
│    ╱  ╲     ╱──╲                          │
│   ╱    ╲___╱    ╲___╱╲                    │
│  ╱                     ╲__                │
└────────────────────────────────────────────┘
┌────────────────────────────────────────────┐
│                 回撤曲线                    │
│  0% ────────────────────────────────       │
│     ▓▓▓▓░░░░░▓▓▓▓▓▓░░░░░▓▓▓▓▓▓▓▓▓▓       │
│ -15%                                       │
└────────────────────────────────────────────┘
```

#### 2.1.4 交易记录表 (Trade Records Table)

**需求描述**: 展示详细的交易记录

**字段列表**:
| 字段 | 说明 |
|-----|------|
| 序号 | 交易序号 |
| 交易时间 | 成交时间 |
| 交易方向 | 买入/卖出 |
| 成交价格 | 实际成交价 |
| 成交数量 | 交易股数 |
| 成交金额 | 交易总额 |
| 手续费 | 交易费用 |
| 盈亏金额 | 单笔盈亏(卖出时) |
| 盈亏比例 | 单笔收益率 |
| 持仓天数 | 本次持仓时长 |

**功能要求**:
- 支持分页显示
- 支持按列排序
- 支持筛选(买入/卖出、盈利/亏损)
- 支持导出CSV/Excel
- 盈利显示红色，亏损显示绿色

#### 2.1.5 收益分析图 (Return Analysis Charts)

**需求描述**: 多维度分析收益情况

**图表类型**:

1. **月度收益热力图**
```
      1月  2月  3月  4月  5月  6月  ...
2023  +5% -2%  +8% +3% -1%  +6%
2024  +2% +4%  -3% +1% +7%  +2%
```

2. **收益分布直方图**
- X轴: 单笔收益率区间
- Y轴: 交易次数
- 显示正态分布拟合曲线

3. **持仓时间分布**
- 饼图显示不同持仓天数的交易占比

4. **累计收益对比**
- 策略收益 vs 买入持有 vs 基准指数

#### 2.1.6 参数优化结果展示 (Parameter Optimization Results)

**需求描述**: 展示策略参数优化的结果对比

**功能要求**:
- 表格展示所有参数组合及其绩效指标
- 高亮最优参数组合
- 支持按指标排序(收益率、夏普比率、最大回撤等)
- 柱状图对比不同参数的表现
- 热力图展示双参数优化结果

**UI示例**:
```
参数优化结果 (按夏普比率排序)
┌─────────┬─────────┬─────────┬─────────┬─────────┐
│ MA短期  │ MA长期  │ 收益率  │ 最大回撤│ 夏普比率│
├─────────┼─────────┼─────────┼─────────┼─────────┤
│   5     │   20    │ +35.2%  │ -12.3%  │  2.15   │ ★最优
│   10    │   30    │ +28.5%  │ -10.1%  │  1.92   │
│   5     │   30    │ +25.8%  │ -15.2%  │  1.45   │
└─────────┴─────────┴─────────┴─────────┴─────────┘
```

### 2.2 非功能需求

#### 2.2.1 性能要求
- 图表渲染时间 < 2秒
- 支持10万条K线数据流畅展示
- 支持1000条交易记录的快速筛选

#### 2.2.2 兼容性要求
- 支持 Chrome/Firefox/Safari/Edge 最新两个版本
- 支持 1920x1080 及以上分辨率
- 移动端自适应布局

#### 2.2.3 可访问性要求
- 图表支持数据表格备选展示
- 颜色对比度符合 WCAG 2.0 标准
- 支持键盘导航

---

## 3. 技术设计

### 3.1 系统架构

```
┌─────────────────────────────────────────────────────────┐
│                      Frontend (Vue3)                     │
├─────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │ PerformancePanel │ KlineChart │ EquityCurve │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │ TradeTable  │  │ ReturnChart │  │ OptimResult │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
├─────────────────────────────────────────────────────────┤
│              Charting Library (ECharts/Plotly)           │
└─────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────┐
│                    Backend (FastAPI)                     │
├─────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │ BacktestAPI │  │AnalyticsAPI│  │  ChartAPI   │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
├─────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐     │
│  │ BacktestSvc │  │AnalyticsSvc│  │  ChartSvc   │     │
│  └─────────────┘  └─────────────┘  └─────────────┘     │
├─────────────────────────────────────────────────────────┤
│                   Backtrader Engine                      │
└─────────────────────────────────────────────────────────┘
```

### 3.2 API 设计

#### 3.2.1 获取回测详细结果
```
GET /api/v1/backtest/{task_id}/detail

Response:
{
  "task_id": "uuid",
  "status": "completed",
  "metrics": {
    "initial_capital": 100000,
    "final_assets": 125000,
    "total_return": 0.25,
    "annualized_return": 0.185,
    "max_drawdown": -0.125,
    "sharpe_ratio": 1.85,
    "win_rate": 0.583,
    "profit_factor": 2.1,
    "trade_count": 24,
    "avg_holding_days": 15
  },
  "equity_curve": [
    {"date": "2024-01-01", "total": 100000, "cash": 100000, "position": 0},
    ...
  ],
  "drawdown_curve": [
    {"date": "2024-01-01", "drawdown": 0},
    ...
  ],
  "trades": [
    {
      "id": 1,
      "datetime": "2024-01-15 09:30:00",
      "direction": "buy",
      "price": 10.5,
      "size": 1000,
      "value": 10500,
      "commission": 5.25,
      "pnl": null,
      "return_pct": null
    },
    ...
  ]
}
```

#### 3.2.2 获取K线与交易信号
```
GET /api/v1/backtest/{task_id}/kline

Response:
{
  "symbol": "600000.SH",
  "klines": [
    {
      "date": "2024-01-01",
      "open": 10.0,
      "high": 10.5,
      "low": 9.8,
      "close": 10.3,
      "volume": 1000000
    },
    ...
  ],
  "signals": [
    {"date": "2024-01-15", "type": "buy", "price": 10.5},
    {"date": "2024-02-20", "type": "sell", "price": 11.2},
    ...
  ],
  "indicators": {
    "ma5": [...],
    "ma10": [...],
    "ma20": [...]
  }
}
```

#### 3.2.3 获取参数优化结果
```
GET /api/v1/backtest/{task_id}/optimization

Response:
{
  "parameters": ["ma_short", "ma_long"],
  "results": [
    {
      "params": {"ma_short": 5, "ma_long": 20},
      "metrics": {
        "total_return": 0.352,
        "max_drawdown": -0.123,
        "sharpe_ratio": 2.15
      }
    },
    ...
  ],
  "best": {
    "params": {"ma_short": 5, "ma_long": 20},
    "metrics": {...}
  }
}
```

### 3.3 前端组件设计

#### 3.3.1 组件结构
```
frontend/src/
├── components/
│   └── charts/
│       ├── KlineChart.vue          # K线图(已有,需增强)
│       ├── EquityCurve.vue         # 资金曲线(已有,需增强)
│       ├── PerformancePanel.vue    # 绩效指标面板(新增)
│       ├── TradeSignalChart.vue    # 交易信号K线图(新增)
│       ├── DrawdownChart.vue       # 回撤曲线图(新增)
│       ├── ReturnHeatmap.vue       # 收益热力图(新增)
│       ├── ReturnDistribution.vue  # 收益分布图(新增)
│       ├── OptimizationChart.vue   # 参数优化图(新增)
│       └── index.ts
├── views/
│   └── BacktestResultPage.vue      # 回测结果详情页(新增)
└── api/
    └── analytics.ts                # 分析API(新增)
```

#### 3.3.2 PerformancePanel 组件
```vue
<template>
  <div class="grid grid-cols-4 gap-4">
    <MetricCard
      v-for="metric in metrics"
      :key="metric.key"
      :title="metric.title"
      :value="metric.value"
      :change="metric.change"
      :format="metric.format"
    />
  </div>
</template>
```

#### 3.3.3 TradeSignalChart 组件
```vue
<template>
  <div ref="chartRef" class="w-full h-[600px]"></div>
</template>

<script setup lang="ts">
// 使用 ECharts 实现带交易信号的K线图
// 参考 stock-backtrader-web-app 的 draw_pro_kline 实现
</script>
```

### 3.4 后端服务设计

#### 3.4.1 新增服务
```python
# backend/app/services/analytics_service.py

class AnalyticsService:
    """回测分析服务"""
    
    async def calculate_metrics(self, task_id: str) -> PerformanceMetrics:
        """计算绩效指标"""
        pass
    
    async def get_equity_curve(self, task_id: str) -> List[EquityPoint]:
        """获取资金曲线"""
        pass
    
    async def get_drawdown_curve(self, task_id: str) -> List[DrawdownPoint]:
        """获取回撤曲线"""
        pass
    
    async def get_trade_signals(self, task_id: str) -> List[TradeSignal]:
        """获取交易信号"""
        pass
    
    async def get_monthly_returns(self, task_id: str) -> Dict[str, Dict[str, float]]:
        """获取月度收益"""
        pass
```

#### 3.4.2 Backtrader 分析器增强
```python
# backend/app/services/backtest_analyzers.py

class DetailedTradeAnalyzer(bt.Analyzer):
    """详细交易分析器"""
    
    def get_analysis(self):
        return {
            'trades': self.trades,
            'equity_curve': self.equity_curve,
            'signals': self.signals
        }

class MonthlyReturnsAnalyzer(bt.Analyzer):
    """月度收益分析器"""
    pass
```

---

## 4. 开发计划

### 4.1 Sprint 划分

#### Sprint 1: 基础设施 (3天)
- [ ] 设计并实现后端分析API
- [ ] 增强Backtrader分析器
- [ ] 创建前端组件骨架

#### Sprint 2: 核心图表 (5天)
- [ ] 实现绩效指标面板
- [ ] 实现交易信号K线图
- [ ] 实现增强版资金曲线

#### Sprint 3: 扩展图表 (4天)
- [ ] 实现回撤曲线图
- [ ] 实现收益热力图
- [ ] 实现收益分布图

#### Sprint 4: 高级功能 (3天)
- [ ] 实现参数优化结果展示
- [ ] 实现交易记录表格
- [ ] 实现数据导出功能

#### Sprint 5: 优化与测试 (3天)
- [ ] 性能优化
- [ ] 响应式适配
- [ ] E2E测试
- [ ] 文档完善

### 4.2 里程碑

| 里程碑 | 日期 | 交付物 |
|-------|------|--------|
| M1 | Sprint 1 完成 | API接口可用 |
| M2 | Sprint 2 完成 | 核心图表可用 |
| M3 | Sprint 4 完成 | 功能完整 |
| M4 | Sprint 5 完成 | 可发布版本 |

### 4.3 风险评估

| 风险 | 影响 | 概率 | 缓解措施 |
|-----|------|------|---------|
| 图表库性能问题 | 高 | 中 | 数据采样、虚拟滚动 |
| Backtrader数据格式不兼容 | 中 | 低 | 数据适配层 |
| 移动端适配困难 | 中 | 中 | 渐进式增强 |

---

## 5. 验收标准

### 5.1 功能验收
- [ ] 绩效指标面板显示10个核心指标
- [ ] K线图支持MA均线和买卖点标记
- [ ] 资金曲线支持多线展示和回撤高亮
- [ ] 交易记录支持排序、筛选、导出
- [ ] 参数优化结果支持对比展示

### 5.2 性能验收
- [ ] 10000条K线数据渲染 < 2秒
- [ ] 页面首次加载 < 3秒
- [ ] 图表交互响应 < 100ms

### 5.3 质量验收
- [ ] 单元测试覆盖率 > 80%
- [ ] E2E测试全部通过
- [ ] 无严重/高危Bug

---

## 6. 附录

### 6.1 参考资料
- [ECharts K线图文档](https://echarts.apache.org/examples/zh/index.html#chart-type-candlestick)
- [Plotly.js Candlestick文档](https://plotly.com/javascript/candlestick-charts/)
- [Backtrader Analyzers文档](https://www.backtrader.com/docu/analyzers/analyzers/)
- [stock-backtrader-web-app源码](../../../stock-backtrader-web-app/)

### 6.2 术语表
| 术语 | 定义 |
|-----|------|
| 夏普比率 | (策略收益-无风险收益)/策略波动率 |
| 最大回撤 | 从峰值到谷值的最大跌幅 |
| 胜率 | 盈利交易次数/总交易次数 |
| 盈亏比 | 平均盈利/平均亏损 |
