# 迭代103 - 功能完善

> 基于 docs/AGILE_DEVELOPMENT.md 的规划，对现有实现进行差距分析并补齐缺失功能

---

## 1. 现状分析

### Epic 1: 后端基础架构 — ✅ 基本完成

| 用户故事 | 状态 | 说明 |
|---------|------|------|
| US-1.1 项目初始化 | ✅ 完成 | FastAPI + 目录结构 + .env配置 + 日志 |
| US-1.2 数据库抽象层 | ⚠️ 90% | SQLite可用，Repository模式已实现；缺 MongoRepository |
| US-1.3 用户认证 | ✅ 完成 | register/login/JWT中间件/bcrypt加密 |

**缺失项**:
- MongoRepository 未实现（优先级低，SQLite已满足需求）

### Epic 2: 回测核心服务 — ⚠️ 大部分完成

| 用户故事 | 状态 | 说明 |
|---------|------|------|
| US-2.1 回测API | ✅ 完成 | run/get/list/delete 四个端点齐全 |
| US-2.2 回测结果存储 | ⚠️ 85% | 持久化已实现；**缺少排序查询**（按时间/策略/收益） |
| US-2.3 异步回测任务 | ⚠️ 70% | asyncio后台执行+task_id轮询已实现；**缺少取消任务API** |

**缺失项**:
1. 回测列表不支持按时间/策略/收益排序
2. 无法取消运行中的回测任务
3. WebSocket推送回测进度未集成（websocket_manager.py已存在但未接入回测流程）

### Epic 3: 前端框架搭建 — ⚠️ 大部分完成

| 用户故事 | 状态 | 说明 |
|---------|------|------|
| US-3.1 Vue3项目初始化 | ✅ 完成 | Vite+Vue3+TS+Pinia+ElementPlus+Axios |
| US-3.2 布局框架 | ⚠️ 80% | 侧边栏+Header已有；**缺少暗色/亮色主题切换** |
| US-3.3 登录页面 | ✅ 完成 | 登录/注册/表单验证/Token存储 |

**缺失项**:
1. 暗色/亮色主题切换

### Epic 4: 可视化图表 — ⚠️ 大部分完成

| 用户故事 | 状态 | 说明 |
|---------|------|------|
| US-4.1 K线图组件 | ✅ 完成 | OHLC+MA+成交量+DataZoom+十字线+Tooltip |
| US-4.2 资金曲线图 | ⚠️ 60% | 基础折线图已有；**缺少基准对比线、回撤阴影、买卖点标记** |
| US-4.3 回测统计面板 | ✅ 完成 | 收益率/年化/夏普/回撤/胜率/交易次数 |

**缺失项**:
1. 资金曲线缺少基准对比线（如沪深300）
2. 回撤区域阴影显示
3. 买卖点标记

### Epic 5: 策略管理 — ⚠️ 部分完成

| 用户故事 | 状态 | 说明 |
|---------|------|------|
| US-5.1 策略列表 | ✅ 完成 | 列表+搜索筛选+删除 |
| US-5.2 策略创建 | ⚠️ 50% | 模板选择+参数配置已有；**缺少Monaco代码编辑器和语法高亮** |
| US-5.3 YAML策略配置 | ❌ 未实现 | 整体未实现 |

**缺失项**:
1. 策略编辑器使用的是普通textarea，缺少Monaco Editor和Python语法高亮
2. 缺少代码校验功能
3. YAML策略配置整体未实现

---

## 2. 本迭代实现计划

按优先级排序，本迭代实现以下功能：

### P0 - 必须实现

| # | 功能 | 对应用户故事 | 改动范围 |
|---|------|------------|---------|
| 1 | 回测列表排序查询 | US-2.2 | 后端 backtest API + service |
| 2 | 取消回测任务 API | US-2.3 | 后端 backtest API + service |
| 3 | Monaco 代码编辑器 | US-5.2 | 前端 StrategyPage.vue |

### P1 - 应该实现

| # | 功能 | 对应用户故事 | 改动范围 |
|---|------|------------|---------|
| 4 | 暗色/亮色主题切换 | US-3.2 | 前端全局 |
| 5 | 资金曲线增强（回撤阴影+买卖点） | US-4.2 | 前端 EquityCurve.vue |

### P2 - 可以延后

| # | 功能 | 对应用户故事 |
|---|------|------------|
| 6 | WebSocket 推送回测进度 | US-2.3 |
| 7 | YAML 策略配置 | US-5.3 |
| 8 | MongoRepository | US-1.2 |
| 9 | 资金曲线基准对比线 | US-4.2 |

---

## 3. 实现记录

### ✅ 已完成

#### 1. 回测列表排序查询 (US-2.2)
- **文件**: `src/backend/app/db/sql_repository.py`
  - `list()` 新增 `order_by` + `order_desc` 参数
- **文件**: `src/backend/app/services/backtest_service.py`
  - `list_results()` 透传排序参数
- **文件**: `src/backend/app/api/backtest.py`
  - `GET /` 新增 `sort_by` 和 `sort_order` 查询参数

#### 2. 取消回测任务 API (US-2.3)
- **文件**: `src/backend/app/api/backtest.py`
  - 新增 `POST /{task_id}/cancel` 端点
- **文件**: `src/backend/app/services/backtest_service.py`
  - 新增 `cancel_task()` 方法，支持取消 asyncio 任务
  - `_execute_backtest()` 增加 `CancelledError` 处理和任务引用清理

#### 3. Monaco 代码编辑器 (US-5.2)
- **新文件**: `src/frontend/src/components/common/MonacoEditor.vue`
  - 封装 Monaco Editor 为 Vue 组件，支持 Python 语法高亮
  - v-model 双向绑定、主题切换、只读模式
- **文件**: `src/frontend/src/views/StrategyPage.vue`
  - 策略代码编辑区由 textarea 替换为 MonacoEditor
- **依赖**: `monaco-editor` + `@monaco-editor/loader`

#### 4. 暗色/亮色主题切换 (US-3.2)
- **文件**: `src/frontend/src/components/common/AppLayout.vue`
  - Header 新增 🌙/☀️ 主题切换按钮
  - 主题偏好持久化到 localStorage
- **文件**: `src/frontend/tailwind.config.js`
  - 启用 `darkMode: 'class'`
- **文件**: `src/frontend/src/style.css`
  - 新增 `html.dark` 下的 Element Plus / Tailwind 暗色覆盖样式

#### 5. 资金曲线增强 (US-4.2)
- **文件**: `src/frontend/src/components/charts/EquityCurve.vue`
  - 支持双入口 props：`data: EquityPoint[]` 或 `equity/dates/drawdown` 数组
  - 新增回撤区域阴影子图（红色填充，独立 yAxis，inverse 显示）
  - 新增买卖点散点标记（买入▲红 / 卖出◆绿）
  - DataZoom 联动主图和回撤子图

#### 6. WebSocket 推送回测进度 (US-2.3)
- **文件**: `src/backend/app/main.py`
  - 新增 `ws/backtest/{task_id}` WebSocket 端点
  - 导入 `websocket_manager` 全局实例
- **文件**: `src/backend/app/services/backtest_service.py`
  - `_execute_backtest()` 在数据下载(30%)、保存结果(80%)、完成(100%)、失败、取消各阶段推送进度消息
- **文件**: `src/frontend/src/views/BacktestPage.vue`
  - 新增 WebSocket 客户端，实时接收进度并展示进度条
  - 新增取消按钮，调用 `POST /{task_id}/cancel`
  - WebSocket 失败自动回退为 HTTP 轮询
- **文件**: `src/frontend/src/api/backtest.ts`
  - 新增 `cancel()` 方法

#### 7. 行情数据真实查询 (DataPage)
- **新文件**: `src/backend/app/api/data.py`
  - `GET /api/v1/data/kline` 端点，使用 akshare 下载真实A股K线数据
  - 返回 OHLCV + 涨跌幅，同时提供 K线图格式和表格格式
- **文件**: `src/backend/app/main.py`
  - 注册 `data_router` 到 `/api/v1/data`
- **文件**: `src/frontend/src/views/DataPage.vue`
  - 替换模拟随机数据为真实后端 API 调用

#### 8. Monaco Editor 包体积优化
- **文件**: `src/frontend/vite.config.ts`
  - `rollupOptions.manualChunks` 将 monaco-editor 分离为独立 chunk
  - 仅在访问策略页面时按需加载（3.7MB → 独立异步加载）

#### 9. 策略库自动发现与展示 (US-1.1 / US-3.1)
- **文件**: `src/backend/app/services/strategy_service.py`
  - 重写为自动扫描 `strategies/*/config.yaml` + `strategy_*.py`
  - 启动时自动发现 **119个策略模板**，替换原来硬编码的3个
  - `_infer_category()` 智能推断策略分类（趋势/均值回归/波动率/指标/套利/其他）
  - `get_template_by_id()` 快速查找 + `get_strategy_readme()` 读取 README.md
- **文件**: `src/backend/app/api/strategy.py`
  - 新增 `GET /templates/{id}` 获取单个模板详情
  - 新增 `GET /templates/{id}/readme` 获取策略 README 文档
  - templates 列表支持 `?category=` 筛选
- **文件**: `src/frontend/src/api/strategy.ts`
  - 新增 `getTemplateDetail()` 和 `getTemplateReadme()` API 方法
- **文件**: `src/frontend/src/views/StrategyPage.vue` (完全重写)
  - 双 Tab 布局：策略库（模板卡片网格） / 我的策略（表格）
  - 搜索 + 分类 Radio 筛选（趋势/均值回归/波动率/指标/套利/其他）
  - 策略卡片：名称、描述、参数数量、分类标签、操作按钮
  - 策略详情弹窗：参数表、README 文档渲染、Monaco 代码查看
  - 分页（每页12个）、卡片悬浮动效
  - "去回测" 按钮携带 `?strategy=` 参数跳转回测页

#### 10. 回测页策略选择器增强
- **文件**: `src/frontend/src/views/BacktestPage.vue`
  - 策略选择器改为分组下拉：策略库（119个模板） / 我的策略
  - 支持 `filterable` 搜索
  - 接收 `?strategy=` 查询参数自动选中策略
  - 回测历史表格显示策略中文名而非原始 ID
- **文件**: `src/frontend/src/views/Dashboard.vue`
  - 最近回测表格同样显示策略中文名

#### 11. 回测服务策略加载增强
- **文件**: `src/backend/app/services/backtest_service.py`
  - `_get_strategy_class()` 支持双来源查找：先查文件模板，再查数据库用户策略
  - 使用 `get_template_by_id()` O(1) 查找替代原来的线性遍历

#### 12. WebSocket 代理 + Vite 开发配置
- **文件**: `src/frontend/vite.config.ts`
  - 新增 `/ws` WebSocket 代理到后端，支持本地开发调试

### 🔜 待后续迭代

| 功能 | 优先级 |
|------|--------|
| YAML 策略配置 | P2 |
| MongoRepository | P2 |
| 资金曲线基准对比线（如沪深300） | P2 |
