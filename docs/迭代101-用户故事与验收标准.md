# 迭代101 - 用户故事与验收标准

## 1. Epic: 回测分析可视化优化

### Epic 描述
作为量化交易者，我希望能够通过专业的可视化界面查看回测结果，以便更好地分析策略表现和做出优化决策。

---

## 2. 用户故事

### US-101-01: 绩效指标面板

**标题**: 查看回测绩效指标概览

**故事描述**:
```
作为 量化交易者
我想要 在回测结果页面顶部看到关键绩效指标的卡片展示
以便于 快速了解策略的整体表现
```

**验收标准**:
- [ ] AC1: 显示初始资金和最终资产，最终资产显示相对初始资金的涨跌百分比
- [ ] AC2: 显示总收益率和年化收益率，正值显示绿色/红色（可配置），负值显示红色/绿色
- [ ] AC3: 显示最大回撤百分比，以负值形式展示
- [ ] AC4: 显示夏普比率，保留2位小数
- [ ] AC5: 显示胜率和盈亏比
- [ ] AC6: 显示交易次数和平均持仓天数
- [ ] AC7: 指标卡片支持悬停显示详细说明tooltip
- [ ] AC8: 页面加载时显示loading状态

**优先级**: P0 (必须)

**故事点**: 3

---

### US-101-02: 交易信号K线图

**标题**: 查看带买卖点标记的K线图

**故事描述**:
```
作为 量化交易者
我想要 在K线图上看到策略的买入和卖出点位标记
以便于 直观理解策略的交易逻辑和时机选择
```

**验收标准**:
- [ ] AC1: 显示标准蜡烛图，红涨绿跌（或可配置）
- [ ] AC2: 叠加MA5/MA10/MA20/MA60均线，可单独显示/隐藏
- [ ] AC3: 买入点用红色向上三角标记，显示在K线下方
- [ ] AC4: 卖出点用绿色向下三角标记，显示在K线上方
- [ ] AC5: 底部显示成交量柱状图，与K线颜色对应
- [ ] AC6: 支持鼠标滚轮缩放和拖拽平移
- [ ] AC7: 支持十字光标，悬停显示日期、OHLC、成交量、涨跌幅
- [ ] AC8: 提供时间范围快速选择：1月/3月/6月/1年/全部
- [ ] AC9: 支持导出图表为PNG图片

**优先级**: P0 (必须)

**故事点**: 8

---

### US-101-03: 资金曲线图

**标题**: 查看资金变化曲线

**故事描述**:
```
作为 量化交易者
我想要 查看策略运行期间的资金变化情况
以便于 了解资金增长趋势和波动情况
```

**验收标准**:
- [ ] AC1: 主图显示总资产曲线（实线）
- [ ] AC2: 可选显示现金曲线（虚线）和持仓市值曲线（点线）
- [ ] AC3: 可选叠加基准指数收益曲线进行对比
- [ ] AC4: Y轴支持切换：绝对金额 / 收益率百分比
- [ ] AC5: 支持鼠标悬停显示具体日期和数值
- [ ] AC6: 支持缩放和平移

**优先级**: P0 (必须)

**故事点**: 5

---

### US-101-04: 回撤曲线图

**标题**: 查看回撤变化曲线

**故事描述**:
```
作为 量化交易者
我想要 查看策略的回撤情况
以便于 了解策略的风险特征和最大亏损可能
```

**验收标准**:
- [ ] AC1: 显示回撤曲线（负值区域），使用面积填充
- [ ] AC2: 用不同颜色高亮最大回撤区间
- [ ] AC3: 标注最大回撤的起止日期和持续天数
- [ ] AC4: 显示当前回撤值
- [ ] AC5: 与资金曲线图共享X轴，支持联动缩放

**优先级**: P1 (重要)

**故事点**: 3

---

### US-101-05: 交易记录表格

**标题**: 查看详细交易记录

**故事描述**:
```
作为 量化交易者
我想要 查看每笔交易的详细记录
以便于 分析具体的交易执行情况和盈亏明细
```

**验收标准**:
- [ ] AC1: 表格显示字段：序号、时间、方向、价格、数量、金额、手续费、盈亏、收益率、持仓天数
- [ ] AC2: 盈利记录显示绿色/红色，亏损记录显示红色/绿色
- [ ] AC3: 支持按任意列排序（升序/降序）
- [ ] AC4: 支持按交易方向筛选（全部/买入/卖出）
- [ ] AC5: 支持按盈亏筛选（全部/盈利/亏损）
- [ ] AC6: 支持分页显示，每页可选10/20/50/100条
- [ ] AC7: 显示汇总统计：总交易次数、总盈利次数、总亏损次数、总手续费
- [ ] AC8: 支持导出为CSV/Excel文件

**优先级**: P0 (必须)

**故事点**: 5

---

### US-101-06: 月度收益热力图

**标题**: 查看月度收益分布

**故事描述**:
```
作为 量化交易者
我想要 以热力图形式查看每月的收益情况
以便于 发现策略在不同时间段的表现规律
```

**验收标准**:
- [ ] AC1: 以年份为Y轴，月份为X轴，显示热力图
- [ ] AC2: 颜色映射：盈利越多越红，亏损越多越绿，零收益为白色
- [ ] AC3: 每个单元格显示具体收益率数值
- [ ] AC4: 悬停显示年月和具体收益率
- [ ] AC5: 右侧显示年度收益汇总
- [ ] AC6: 底部显示月度平均收益

**优先级**: P1 (重要)

**故事点**: 3

---

### US-101-07: 收益分布直方图

**标题**: 查看单笔收益分布

**故事描述**:
```
作为 量化交易者
我想要 查看单笔交易收益的分布情况
以便于 了解策略收益的分布特征
```

**验收标准**:
- [ ] AC1: X轴为收益率区间，Y轴为交易次数
- [ ] AC2: 可选显示正态分布拟合曲线
- [ ] AC3: 显示关键统计指标：均值、中位数、标准差、偏度、峰度
- [ ] AC4: 盈利区间显示绿色/红色，亏损区间显示红色/绿色
- [ ] AC5: 支持调整区间数量

**优先级**: P2 (一般)

**故事点**: 3

---

### US-101-08: 参数优化结果展示

**标题**: 查看参数优化对比结果

**故事描述**:
```
作为 量化交易者
我想要 查看不同参数组合的回测结果对比
以便于 选择最优的策略参数
```

**验收标准**:
- [ ] AC1: 表格显示所有参数组合及其绩效指标
- [ ] AC2: 支持按任意指标列排序
- [ ] AC3: 高亮显示最优参数组合（可选按收益率/夏普比率/最大回撤）
- [ ] AC4: 柱状图对比前N个参数组合的表现
- [ ] AC5: 双参数优化时，显示热力图形式的结果
- [ ] AC6: 点击某个参数组合可跳转查看其详细回测结果

**优先级**: P1 (重要)

**故事点**: 5

---

### US-101-09: 回测结果导出

**标题**: 导出回测分析报告

**故事描述**:
```
作为 量化交易者
我想要 将回测结果导出为文件
以便于 存档记录或分享给他人
```

**验收标准**:
- [ ] AC1: 支持导出CSV格式（交易记录、资金曲线数据）
- [ ] AC2: 支持导出Excel格式（包含多个工作表）
- [ ] AC3: 支持导出图表为PNG图片
- [ ] AC4: 导出文件名包含策略名称和时间戳

**优先级**: P2 (一般)

**故事点**: 2

---

## 3. 技术故事

### TS-101-01: 后端分析API开发

**描述**: 开发回测分析相关的后端API接口

**任务**:
- [ ] 设计并实现 `/api/v1/analytics/{task_id}/detail` 接口
- [ ] 设计并实现 `/api/v1/analytics/{task_id}/kline` 接口
- [ ] 设计并实现 `/api/v1/analytics/{task_id}/optimization` 接口
- [ ] 设计并实现 `/api/v1/analytics/{task_id}/monthly-returns` 接口
- [ ] 设计并实现 `/api/v1/analytics/{task_id}/export` 接口
- [ ] 编写API单元测试

**故事点**: 5

---

### TS-101-02: Backtrader分析器增强

**描述**: 增强Backtrader回测引擎的数据采集能力

**任务**:
- [ ] 实现 DetailedTradeAnalyzer 详细交易分析器
- [ ] 实现 EquityCurveAnalyzer 资金曲线分析器
- [ ] 实现 TradeSignalAnalyzer 交易信号分析器
- [ ] 实现 MonthlyReturnsAnalyzer 月度收益分析器
- [ ] 集成分析器到回测执行流程
- [ ] 编写分析器单元测试

**故事点**: 5

---

### TS-101-03: 前端图表组件库

**描述**: 开发可复用的前端图表组件

**任务**:
- [ ] 封装 ECharts K线图组件
- [ ] 封装资金曲线图组件
- [ ] 封装回撤曲线图组件
- [ ] 封装热力图组件
- [ ] 封装直方图组件
- [ ] 封装指标卡片组件
- [ ] 编写组件文档

**故事点**: 8

---

## 4. Sprint 规划

### Sprint 1: 基础设施 (3天)

| 故事 | 故事点 | 负责人 |
|-----|--------|-------|
| TS-101-01 | 5 | Backend |
| TS-101-02 | 5 | Backend |

**Sprint 目标**: 完成后端API和分析器开发

---

### Sprint 2: 核心图表 (5天)

| 故事 | 故事点 | 负责人 |
|-----|--------|-------|
| US-101-01 | 3 | Frontend |
| US-101-02 | 8 | Frontend |
| US-101-03 | 5 | Frontend |

**Sprint 目标**: 完成绩效面板、K线图、资金曲线

---

### Sprint 3: 扩展图表 (4天)

| 故事 | 故事点 | 负责人 |
|-----|--------|-------|
| US-101-04 | 3 | Frontend |
| US-101-05 | 5 | Frontend |
| US-101-06 | 3 | Frontend |

**Sprint 目标**: 完成回撤图、交易记录、热力图

---

### Sprint 4: 高级功能 (3天)

| 故事 | 故事点 | 负责人 |
|-----|--------|-------|
| US-101-07 | 3 | Frontend |
| US-101-08 | 5 | Frontend |
| US-101-09 | 2 | Frontend |

**Sprint 目标**: 完成收益分布、参数优化、导出功能

---

### Sprint 5: 优化测试 (3天)

| 任务 | 说明 |
|-----|------|
| 性能优化 | 大数据量渲染优化 |
| 响应式适配 | 移动端布局调整 |
| E2E测试 | 完成所有页面测试 |
| 文档完善 | 更新用户手册 |

**Sprint 目标**: 可发布版本

---

## 5. Definition of Done (DoD)

### 功能完成定义
- [ ] 代码通过Code Review
- [ ] 单元测试覆盖率 >= 80%
- [ ] 无P0/P1级别Bug
- [ ] API文档已更新
- [ ] 组件文档已更新

### 发布完成定义
- [ ] 所有Sprint目标达成
- [ ] E2E测试全部通过
- [ ] 性能测试达标
- [ ] 用户手册已更新
- [ ] 发布说明已编写

---

## 6. 风险与依赖

### 风险
| 风险 | 概率 | 影响 | 缓解措施 |
|-----|------|------|---------|
| ECharts大数据量性能问题 | 中 | 高 | 数据采样、增量渲染 |
| Backtrader数据格式兼容 | 低 | 中 | 数据适配层 |
| 复杂图表交互体验 | 中 | 中 | 用户测试反馈迭代 |

### 依赖
- 依赖迭代100完成的基础架构
- 依赖Backtrader回测引擎正常运行
- 依赖前端图表库(ECharts)
