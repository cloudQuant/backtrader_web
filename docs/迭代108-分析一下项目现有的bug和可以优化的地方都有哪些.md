### 背景
现有的功能已经基本实现，剩下的主要是对这些功能进行改进优化了；

### 任务
1. 寻找并发现现有系统有哪些bug
2. 发现并寻找可以优化的地方
3. 把这些地方放到这个文档上线，方便后续进行改进优化

---

### 现状梳理（关键链路）
1. **回测（前端）**
   - 页面: `src/frontend/src/views/BacktestPage.vue`
   - 调用: `src/frontend/src/api/backtest.ts` → `POST /api/v1/backtest/run`
   - WebSocket: `ws://<host>:8000/ws/backtest/{task_id}`（见 `src/backend/app/main.py`）
2. **回测（后端）**
   - 路由: `src/backend/app/api/backtest.py`
   - 执行: `src/backend/app/services/backtest_service.py::_execute_backtest()`
   - 方式: 运行 `strategies/<strategy_id>/run.py` 子进程 → 解析 `strategies/<strategy_id>/logs/` → 指标落库
3. **策略模板**
   - 扫描: `src/backend/app/services/strategy_service.py`（启动时扫描 `strategies/*/config.yaml`）
   - 前端展示: `src/frontend/src/views/StrategyPage.vue`
4. **分析可视化**
   - API: `src/backend/app/api/analytics.py`
   - 前端: `src/frontend/src/views/BacktestResultPage.vue`

### Bug 清单（待修复）

#### P0（阻断/高风险）
1. **[B001] 回测取消基本无效（且无法真正停止子进程）**
   - 位置:
     - `src/backend/app/api/backtest.py`（依赖注入每次 `Depends(get_backtest_service)` 都创建新实例）
     - `src/backend/app/services/backtest_service.py`（`self._running_tasks` 为实例内状态；实际执行是 `subprocess.run()`）
   - 影响:
     - “取消”接口可能返回成功，但回测仍继续跑完；甚至最终把状态更新为完成并写入结果。
   - 建议:
     - 任务注册表做成进程级单例（如 `app.state`/模块全局），并记录子进程 PID；取消时终止子进程并将任务置为 `cancelled`。

2. **[B002] 回测结果/状态接口缺少用户鉴权（结果可被越权读取）**
   - 位置:
     - `src/backend/app/api/backtest.py`：`get_backtest_result()` / `get_backtest_status()`
     - `src/backend/app/services/backtest_service.py::get_result()` / `get_task_status()`（未校验 `task.user_id`）
     - `src/backend/app/api/analytics.py`：`get_backtest_detail()` 等同样依赖 `get_result()`
   - 影响:
     - 任意登录用户只要猜到/拿到 `task_id`，即可读取他人回测结果与交易明细。
   - 建议:
     - `get_result/get_task_status` 增加 `user_id` 参数并校验；或在 API 层统一校验 `task.user_id == current_user.sub`。

3. **[B003] 并发回测存在竞态：共享策略目录写 `config.yaml` / 清空 `logs/`**
   - 位置: `src/backend/app/services/backtest_service.py::_execute_backtest()`
   - 影响:
     - 同一 `strategy_id` 多个任务同时运行时会互相覆盖配置、互删日志，导致结果错乱或解析到别人的日志。
   - 建议:
     - 每个任务使用独立工作目录（例如复制策略目录到临时目录运行），并把输出日志与临时配置写到任务目录。

4. **[B004] “我的策略”（数据库策略）无法回测，但前端允许选择**
   - 位置:
     - 前端: `src/frontend/src/views/BacktestPage.vue`（下拉框包含“我的策略”）
     - 后端: `src/backend/app/services/backtest_service.py::_execute_backtest()`（只支持 `strategies/<id>/run.py`）
   - 影响:
     - 用户选择自定义策略后运行回测会失败：`run.py 不存在`。
   - 建议:
     - 明确产品策略：
       - 要么前端禁用/隐藏“我的策略”回测入口；
       - 要么后端实现数据库策略回测执行路径（不依赖 `run.py`）。

#### P1（重要但不阻断）

1. **[B005] 大量策略 `run.py` 内含硬编码 `assert`，导致“传参回测/调参”很容易失败**
   - 位置:
     - `strategies/*/run.py`（示例: `strategies/002_dual_ma/run.py` 168-176 行）
     - `src/backend/app/services/backtest_service.py::_execute_backtest()`（会根据前端参数写 `config.yaml`，从而触发断言失败）
   - 复现:
     - 前端回测页选择 `002_dual_ma`，修改任一参数（如 `short_period/long_period`）后运行回测
     - 观察后端报错：`run.py 执行失败: AssertionError ...`
   - 影响:
     - 前端“动态参数”能力与大部分策略不兼容；数据文件更新/环境差异也可能导致断言偶发失败
   - 建议:
     - 将断言迁移到单元测试（如 `tests/`），不要放在线上回测执行路径
     - 或用环境变量/开关包裹断言（仅在开发测试模式启用）

2. **[B006] 回测取消的“状态语义”不一致：API 标记为 `failed`，WebSocket 推送 `cancelled`，且基础 `TaskStatus` 不含 `cancelled`**
   - 位置:
     - `src/backend/app/services/backtest_service.py::cancel_task()`（把任务写成 `FAILED`）
     - `src/backend/app/schemas/backtest.py::TaskStatus`（缺少 `CANCELLED`）
     - `src/backend/app/websocket_manager.py`（消息类型包含 `cancelled`，并依赖 `schemas/backtest_enhanced.py::TaskStatus`）
   - 影响:
     - 列表/筛选/统计无法区分“失败”与“取消”；前后端状态展示不一致
   - 建议:
     - 统一 `TaskStatus`（基础/增强）并在 DB 落 `cancelled`
     - 取消时写入一致状态，并保证 API 与 WS 语义一致

3. **[B007] 交易方向字段不一致（`long/short` vs `buy/sell`），导致买卖点/交易表格方向显示与筛选异常**
   - 位置:
     - 后端:
       - `src/backend/app/services/log_parser_service.py::parse_trade_log()`（输出 `direction=long/short`）
       - `src/backend/app/services/backtest_service.py::_parse_backtest_results()`（同样输出 `long/short`）
     - 前端:
       - `src/frontend/src/types/analytics.ts::TradeRecord.direction`（约定为 `buy|sell`）
       - `src/frontend/src/components/charts/TradeSignalChart.vue`（只识别 `type === 'buy'/'sell'`）
       - `src/frontend/src/components/charts/TradeRecordsTable.vue`（方向标签/筛选基于 `buy/sell`）
   - 复现:
     - 打开回测详情页（K线图/交易记录/方向筛选）
     - 观察：买卖点可能不显示，方向标签可能显示错误，筛选无效
   - 建议:
     - 后端统一输出 `buy/sell`（或在 API 层做映射）
     - 或前端兼容 `long/short` 并映射为 `buy/sell`

4. **[B008] 回测详情页的“参数优化结果”接口返回随机模拟数据，前端会当作真实结果展示（严重误导）**
   - 位置:
     - 后端: `src/backend/app/api/analytics.py` → `GET /analytics/{task_id}/optimization`（“生成模拟优化结果”，使用 `random`）
     - 前端: `src/frontend/src/views/BacktestResultPage.vue`（`onMounted` 时自动加载并展示 “参数优化” Tab）
   - 复现:
     - 任意回测任务详情页 → “参数优化”tab 会出现随机结果（即使从未执行优化）
   - 建议:
     - 未实现前返回 404/空，前端基于响应决定是否展示 tab
     - 或对接真实优化模块（`/api/v1/optimization/*`）并以 `task_id`/策略/参数集做关联

5. **[B009] 分析接口读取 `strategies/<id>/logs` 的“最新目录”，与 `task_id` 不绑定，导致旧任务详情数据可能漂移/串任务**
   - 位置:
     - `src/backend/app/api/analytics.py::get_backtest_data()`（`find_latest_log_dir(strategy_dir)`）
     - `src/backend/app/services/log_parser_service.py::find_latest_log_dir()`
     - `src/backend/app/services/backtest_service.py::_execute_backtest()`（会清空 `logs/`，与并发问题 B003 叠加）
   - 影响:
     - 同一策略多次回测后，历史任务详情页的 K 线/信号/现金曲线可能被后续任务覆盖
   - 建议:
     - 每个任务使用独立日志目录，并把 `log_dir`（或任务工作目录）写入 DB
     - 或解析日志后将所需数据（K线、信号、现金曲线等）持久化，分析接口只读 DB

6. **[B010] 参数优化取消无效：仅标记状态，不停止正在运行的 worker，且最终仍可能被覆盖为 `completed`**
   - 位置:
     - `src/backend/app/services/param_optimization_service.py::cancel_optimization()`（仅 `_update_task(status="cancelled")`）
     - `src/backend/app/services/param_optimization_service.py::_run_optimization_thread()`（不检查取消标志，结束时强制 `status="completed"`）
   - 影响:
     - 用户点击取消后仍会继续占用 CPU/进程；状态展示也不可信
   - 建议:
     - 主循环检查取消标志并尽早停止提交/收集 future
     - 记录并终止子进程/worker（或改为可取消的任务队列模型）

#### P2（体验/一致性问题）

1. **[B011] `SQLRepository.list()` 参数名与多处 service 调用不一致，相关模块一启用即 TypeError**
   - 位置:
     - `src/backend/app/db/sql_repository.py::SQLRepository.list()`（参数: `order_by/order_desc`）
     - `src/backend/app/services/comparison_service.py` / `monitoring_service.py` / `paper_trading_service.py` / `strategy_version_service.py`（使用 `sort_by/sort_order`）
   - 影响:
     - 对比/监控/模拟交易/版本管理等模块一旦接入路由就会直接崩溃
   - 建议:
     - 统一 Repository 接口，或在 `SQLRepository.list()` 兼容 `sort_by/sort_order` 参数别名

2. **[B012] “回撤”的单位与正负号在不同链路不一致（% vs fraction；正值 vs 负值）**
   - 位置:
     - `src/backend/app/services/log_parser_service.py::parse_value_log()`（`drawdown_curve` 使用百分比正值）
     - `src/backend/app/api/analytics.py::get_backtest_data()`（`drawdown` 使用负的小数）
     - 前端组件 `PerformancePanel.vue` / `DrawdownChart.vue`（按小数 *100 展示）
   - 影响:
     - Backtest 列表页/详情页展示口径不一致，用户难以理解与对比
   - 建议:
     - 统一约定：后端统一用小数（-0.23）或百分比（23），并在 API schema/前端统一处理

3. **[B013] WebSocket 地址写死 `:8000`，在反向代理/生产环境可能不可用**
   - 位置: `src/frontend/src/views/BacktestPage.vue` → `connectWebSocket()`
   - 影响:
     - 线上同域部署（或端口非 8000）时，WS 连接失败，回退轮询体验较差
   - 建议:
     - 使用可配置的 WS Base URL（环境变量/配置文件），或使用 `window.location.host` 拼接

4. **[B014] 存在多个 FastAPI 入口文件（`main.py/main_updated.py/main_final.py/...`），容易引起路由差异与文档误导**
   - 位置: `src/backend/app/main.py` / `main_updated.py` / `main_final.py` / `main_minimal.py` / `main_final_complete.py`
   - 建议:
     - 明确唯一入口（当前脚本通常使用 `app.main:app`），过期文件归档/删除或在 README 标注用途

5. **[B015] 权限依赖 `deps_permissions.get_current_user()` 为占位 `pass`，若被引用会运行时报错**
   - 位置: `src/backend/app/api/deps_permissions.py`
   - 建议:
     - 未接入前避免在路由中引用该依赖；接入时改为复用 `src/backend/app/api/deps.py::get_current_user`

6. **[B016] API 路由重复注册且命名不一致（`/backtest` vs `/backtests` 等），导致文档/客户端混乱，可能产生行为差异**
   - 位置:
     - `src/backend/app/main.py`（同时 `include_router(api_router, prefix="/api/v1")` + 再次 include 多个子 router）
     - `src/backend/app/api/router.py`（聚合版路由前缀: `/auth` `/backtest` `/strategy` `/analytics` ...）
   - 影响:
     - OpenAPI 文档会出现两套 endpoint（单复数/不同前缀）
     - 新老接口可能行为不一致（例如增强版/旧版），容易引入绕过鉴权或前端调用错误
   - 建议:
     - 明确并保留唯一 API 命名体系（建议对齐前端当前使用的 `/api/v1/backtest` `/api/v1/strategy` ...）
     - 逐步下线另一套路由（或在网关层做重定向/兼容）

7. **[B017] 指标字段命名/单位在不同接口不一致（百分比 vs 小数；`annual_return` vs `annualized_return`），容易造成展示或计算错误**
   - 位置:
     - 回测结果（列表/基本接口）:
       - `src/backend/app/services/log_parser_service.py::parse_all_logs()`（`total_return/annual_return/max_drawdown/win_rate` 多为百分比数值，如 23.26 表示 23.26%）
       - `src/frontend/src/views/BacktestPage.vue`（直接 `toFixed()+"%"` 展示，假设后端已是百分比）
     - 回测分析（详情接口）:
       - `src/backend/app/services/analytics_service.py::calculate_metrics()`（`total_return/annualized_return/max_drawdown/win_rate` 多为小数，如 -0.2326 表示 -23.26%）
       - `src/frontend/src/components/charts/PerformancePanel.vue` + `MetricCard.vue`（`percent` 会 *100 展示）
   - 影响:
     - 同一指标在“列表页 vs 详情页”口径不同，用户难以对比；也容易在前端二次计算时出错
   - 建议:
     - 统一后端输出口径（推荐统一为小数），并在 schema 中明确单位
     - 或在 API 层返回带单位的字段（如同时返回 `total_return_pct`）以避免误用

### 可优化点（非 Bug）

1. **[O001][P0/P1] 回测/优化执行“工作目录与产物”标准化（每任务隔离）**
   - 目标:
     - 彻底解决并发互相覆盖 `config.yaml`、互删 `logs/`、以及分析接口读取 latest logs 造成的串数据
   - 建议落地:
     - 为每个 `task_id` 创建独立工作目录（复制策略目录或用模板+渲染生成）
     - 产出目录结构固定：`task_dir/config.yaml`、`task_dir/logs/...`、`task_dir/run_info.json`
     - DB 中记录 `task_dir/log_dir`，后续解析/分析只基于 task 目录

2. **[O002][P1] 后端/前端类型与枚举统一（状态/方向/单位），减少“隐性不兼容”**
   - 重点:
     - `TaskStatus`（含 cancelled）
     - trade `direction`（buy/sell vs long/short）
     - drawdown 单位（% vs fraction）
   - 建议:
     - 统一 OpenAPI schema 后用工具生成前端类型（或至少集中维护一份常量映射）

3. **[O003][P1] 未实现接口避免返回“看似正常”的模拟数据**
   - 典型: `GET /analytics/{task_id}/optimization`
   - 建议:
     - 未实现时返回 404 或明确的 `{"implemented": false}`，前端据此隐藏入口

4. **[O004][P2] 配置集中化（API/WS BaseURL、端口、代理）**
   - 目标:
     - 避免前端写死 `:8000` / 后端地址，提升部署灵活性
   - 建议:
     - 前端增加统一配置模块（如 `VITE_API_BASE` / `VITE_WS_BASE`）

5. **[O005][P2] Repository 接口规范化与模块可用性自检**
   - 目标:
     - `SQLRepository.list()` 参数与各 service 一致，避免“模块一启用就崩溃”的隐藏问题
   - 建议:
     - 写最小集成测试/启动自检：扫描路由并做一次 list 调用，提前暴露 TypeError