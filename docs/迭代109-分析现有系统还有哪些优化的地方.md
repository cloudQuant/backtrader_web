### 背景
现有的功能已经基本实现，剩下的主要是对这些功能进行改进优化了；

### 任务
1. 寻找并发现现有系统有哪些bug
2. 发现并寻找可以优化的地方
3. 把这些地方放到这个文档上线，方便后续进行改进优化

---

## 一、Bug 列表

### BUG-1：回测状态查询接口变量名遮蔽导致 500 错误
- **文件**: `src/backend/app/api/backtest.py` 第 61-74 行
- **问题**: `get_backtest_status` 函数中，参数名 `status` 与 FastAPI 的 `status` 模块同名。当 `service.get_task_status()` 返回 `None` 时，代码执行 `status.HTTP_404_NOT_FOUND`，但此时 `status` 已经被赋值为 `None`（函数返回值），导致 `AttributeError: 'NoneType' object has no attribute 'HTTP_404_NOT_FOUND'`。
- **严重程度**: 高
- **修复方案**: 将返回值变量名改为 `task_status` 避免遮蔽 `status` 模块。

### BUG-2：交易信号的开仓/平仓价格相同
- **文件**: `src/backend/app/api/analytics.py` 第 128-145 行
- **问题**: 生成开仓和平仓两个信号时，都使用了 `trade['price']`（成交均价），但实际上开仓价和平仓价应该不同。当前 trade 数据中只保存了一个 `price` 字段，缺少 `open_price` 和 `close_price` 的区分。
- **严重程度**: 中
- **修复方案**: 在 `log_parser_service.py` 的 `parse_trade_log` 中额外解析 `open_price` / `close_price`（如果 trade.log 有这些字段的话），或者在信号标记时标注这是近似价格。

### BUG-3：`cancelled` 状态在前端未正确显示
- **文件**: `src/frontend/src/views/BacktestPage.vue` 第 271-288 行
- **问题**: `getStatusType` 和 `getStatusText` 映射表中没有 `cancelled` 状态的条目，导致已取消的任务显示为原始的英文 "cancelled" 而不是中文 "已取消"，且 tag 类型为默认的 `info`。Dashboard.vue 同样存在此问题。
- **严重程度**: 低
- **修复方案**: 在两处映射表中添加 `cancelled: 'warning'` 和 `cancelled: '已取消'`。

### BUG-4：`analytics.ts` 中仍然导入未使用的 `OptimizationResponse`
- **文件**: `src/frontend/src/api/analytics.ts` 第 8 行
- **问题**: `OptimizationResponse` 类型仍在导入，但 `BacktestResultPage.vue` 已不再调用优化接口。虽不影响运行，但 `getOptimizationResults` 方法本身也是死代码。
- **严重程度**: 低
- **修复方案**: 移除 `getOptimizationResults` 方法和 `OptimizationResponse` 导入。

### BUG-5：回测结果缓存未区分用户，存在数据越权风险
- **文件**: `src/backend/app/services/backtest_service.py` 第 643-691 行
- **问题**: `get_result` 方法的缓存 key 仅为 `backtest:result:{task_id}`，不包含 `user_id`。如果用户 A 查看了一个任务结果并缓存，用户 B（理论上无权查看）如果知道 task_id 也能命中缓存并获取数据，绕过了 user_id 校验逻辑。
- **严重程度**: 高
- **修复方案**: 将 user_id 校验放在缓存查询之前，或将 user_id 作为缓存 key 的一部分。

### BUG-6：`health` 接口数据库状态硬编码为 "connected"
- **文件**: `src/backend/app/main.py` 第 169-178 行
- **问题**: 健康检查端点始终返回 `"database": "connected"`，不论数据库是否真的可达。
- **严重程度**: 中
- **修复方案**: 实际执行一次轻量 DB 查询（如 `SELECT 1`），根据结果返回真实的连接状态。

### BUG-7：`datetime.utcnow()` 已弃用
- **文件**: `src/backend/app/utils/security.py` 第 33、35 行
- **问题**: Python 3.12+ 中 `datetime.utcnow()` 已被标记为 deprecated，推荐使用 `datetime.now(timezone.utc)`。
- **严重程度**: 低
- **修复方案**: 替换为 `datetime.now(timezone.utc)`。

### BUG-8：`bare except` 吞掉所有异常
- **文件**: `src/backend/app/api/analytics.py` 第 203 行
- **问题**: `except:` 不带异常类型，会吞掉 `KeyboardInterrupt`、`SystemExit` 等不应被捕获的异常，且不记录任何日志。
- **严重程度**: 中
- **修复方案**: 改为 `except Exception:` 并添加日志。

---

## 二、可优化项

### OPT-1：每次请求都 new 一个 Service 实例
- **文件**: `src/backend/app/api/backtest.py` 第 20-21 行、`analytics.py` 第 31-36 行 等多处
- **问题**: `get_backtest_service()` 每次调用都 `return BacktestService()`，即每个请求创建新实例，也创建新的 `SQLRepository` 和 `Cache` 对象。
- **建议**: 使用 FastAPI 的 `Depends` 配合单例模式或 `lru_cache` 复用服务实例。

### OPT-2：`SQLRepository` 每次操作都创建新 Session
- **文件**: `src/backend/app/db/sql_repository.py`
- **问题**: 每个 `create`/`get_by_id`/`update`/`delete`/`list` 方法都独立创建 `async_session_maker()` 会话。对于 `get_result` 这种需要连续查询 task + result 的场景，产生了不必要的多次连接。
- **建议**: 支持外部传入 session，或使用 request-scoped session 模式。

### OPT-3：`list_results` 方法 N+1 查询问题
- **文件**: `src/backend/app/services/backtest_service.py` 第 730-754 行
- **问题**: `list_results` 先查询所有任务，再对每个任务逐一调用 `get_result`（每次都查询 task + result 两张表），产生 N+1 查询问题。
- **建议**: 使用 JOIN 一次查询获取 task + result 数据。

### OPT-4：回测结果页面三次并行请求获取同一任务数据
- **文件**: `src/frontend/src/views/BacktestResultPage.vue` 第 147-151 行
- **问题**: `loadData` 并行调用 `getBacktestDetail`、`getKlineWithSignals`、`getMonthlyReturns` 三个接口，每个接口内部都调用 `get_backtest_data()` 从数据库读取完整回测结果。也就是同一条数据被读了 3 次。
- **建议**: 合并为一个接口返回所有数据（detail + kline + monthly returns），或在后端对同一 task_id 的短时间内请求做缓存。

### OPT-5：硬编码的安全密钥
- **文件**: `src/backend/app/config.py` 第 15、33 行
- **问题**: `SECRET_KEY` 和 `JWT_SECRET_KEY` 默认值为 `"your-secret-key-change-in-production"` 和 `"your-jwt-secret-change-in-production"`。如果部署时未设置环境变量，使用默认值会造成严重安全风险。
- **建议**: 启动时检测是否使用了默认密钥，如果是则打印警告或在非 DEBUG 模式下拒绝启动。

### OPT-6：默认管理员密码 `admin123` 不安全
- **文件**: `src/backend/app/config.py` 第 43 行、`src/backend/app/db/database.py` 第 40-66 行
- **问题**: 默认管理员密码 `admin123` 过于简单，且每次启动时自动创建。
- **建议**: 仅在首次部署时创建，密码随机生成并输出到终端/日志，或提示用户首次登录时修改。

### OPT-7：子进程超时时间硬编码为 300 秒
- **文件**: `src/backend/app/services/backtest_service.py` 第 309 行
- **问题**: `proc.communicate(timeout=300)` 超时时间固定为 5 分钟。对于大型策略和长时间回测可能不够，但又不可配置。
- **建议**: 将超时时间提取到 `config.py` 中作为可配置参数。

### OPT-8：`parse_all_logs` 在函数内部 `import numpy`
- **文件**: `src/backend/app/services/log_parser_service.py` 第 304 行
- **问题**: 每次调用 `parse_all_logs` 都在函数体内 `import numpy as np`。虽然 Python 会缓存模块，但这属于不好的代码风格。
- **建议**: 将 `import numpy as np` 移到文件顶部。

### OPT-9：前端 WebSocket URL 端口判断逻辑脆弱
- **文件**: `src/frontend/src/views/BacktestPage.vue` 第 291-294 行
- **问题**: `const wsPort = window.location.port === '3000' ? '8000' : window.location.port || '8000'`。这种硬编码端口映射在非标准部署场景（如 Docker 端口映射、Nginx 反向代理等）下会失败。
- **建议**: 通过环境变量配置后端 WebSocket 地址，或使用相对路径让 Nginx 代理 WebSocket。

### OPT-10：CORS 允许的源硬编码
- **文件**: `src/backend/app/main.py` 第 131 行
- **问题**: `allow_origins=["http://localhost:5173", "http://localhost:3000"]` 硬编码，生产环境需要手动修改代码。
- **建议**: 从环境变量或 `config.py` 读取允许的域名列表。

### OPT-11：SQL `echo=True` 在 DEBUG 模式下输出大量日志
- **文件**: `src/backend/app/db/database.py` 第 14 行
- **问题**: `echo=settings.DEBUG` 在 DEBUG 为 True 时将所有 SQL 语句打印到标准输出，在回测结果页面（大量查询）时产生大量日志噪音。
- **建议**: 单独设置 `SQL_ECHO` 配置项，或默认关闭。

### OPT-12：前端导出功能使用 `window.open` 无认证
- **文件**: `src/frontend/src/api/analytics.ts` 第 58-61 行
- **问题**: `exportResults` 使用 `window.open(url, '_blank')` 打开新窗口下载，但新窗口不会携带 JWT token（存在 localStorage 中的 Bearer token 只在 axios 请求中自动附加）。如果后端接口需要认证，下载会失败。
- **建议**: 改用 axios 请求获取 blob 再触发下载，或后端提供一次性下载 token。

### OPT-13：`_running_tasks` / `_running_processes` 全局状态在多 worker 下失效
- **文件**: `src/backend/app/services/backtest_service.py` 第 32-33 行
- **问题**: 进程级全局字典 `_running_tasks` 和 `_running_processes` 在多 worker（如 `uvicorn --workers 4`）部署时，每个 worker 有自己的进程空间，取消请求可能发送到不同 worker 而找不到对应的任务/进程。
- **建议**: 如果需要多 worker 部署，使用 Redis 或数据库追踪 PID + worker 信息。单 worker 则在文档中说明限制。

### OPT-14：回测临时日志复制到原策略目录造成磁盘累积
- **文件**: `src/backend/app/services/backtest_service.py` 第 186-189 行
- **问题**: 每次回测将日志从临时目录复制到 `strategy_dir/logs/task_{task_id}/`。随着回测次数增加，这些日志文件会不断累积，没有清理机制。
- **建议**: 定期清理过期日志，或在删除回测结果时同步删除对应的日志目录。

### OPT-15：前端 Dashboard 统计数据仅基于前 5 条记录
- **文件**: `src/frontend/src/views/Dashboard.vue` 第 186-203 行
- **问题**: `backtestStore.fetchResults(5)` 只获取最近 5 条回测结果，但 `avgReturn` 和 `bestSharpe` 是基于这 5 条计算的，不代表全量统计数据。
- **建议**: 后端提供专门的统计接口返回全量汇总数据。

### OPT-16：`_get_stock_data` / `_run_backtrader` 等方法已不再使用
- **文件**: `src/backend/app/services/backtest_service.py` 第 320-641 行
- **问题**: `_get_stock_data`、`_get_strategy_class`、`_load_strategy_from_code`、`_parse_backtest_results`、`_run_backtrader` 等方法是早期直接通过 backtrader API 运行回测的代码，现在已经改为子进程调用 `run.py` 方式。这些代码约 300 行完全死代码。
- **建议**: 删除不再使用的方法，减少维护负担。

### OPT-17：`KlineChart.vue` 组件未被任何页面使用
- **文件**: `src/frontend/src/components/charts/KlineChart.vue`
- **问题**: 该组件是早期简单 K 线图实现，现已被功能更完善的 `TradeSignalChart.vue` 替代，但文件仍保留在代码库中。
- **建议**: 如果确认不再需要，可以删除以减少混淆。

### OPT-18：回测结果页面切换 Tab 时不必要的重新渲染
- **文件**: `src/frontend/src/views/BacktestResultPage.vue`
- **问题**: `v-if="activeTab === 'equity'"` 和 `v-if="activeTab === 'analysis'"` 控制组件的挂载/卸载。每次切换 Tab 都会重新创建 ECharts 实例和重新渲染。
- **建议**: 使用 `v-show` 替代 `v-if` 可避免重复渲染（但会增加初始加载时间），或使用 `<keep-alive>` 缓存组件。

### OPT-19：前端 Token 过期无刷新机制
- **文件**: `src/frontend/src/stores/auth.ts`
- **问题**: JWT Token 过期后（24小时），用户请求会直接报 401 错误，store 调用 `logout()` 清除 token 跳转登录页，用户正在进行的操作（如回测）会丢失。
- **建议**: 实现 refresh token 机制，或在 token 即将过期时自动续期。

### OPT-20：`analytics.py` 中 `get_backtest_data` 函数过于庞大
- **文件**: `src/backend/app/api/analytics.py` 第 55-225 行
- **问题**: 这个函数有约 170 行，包含了数据库查询、资金曲线转换、信号生成、K线解析、月度收益计算等多项逻辑，职责不单一。
- **建议**: 将各部分逻辑抽取到 `AnalyticsService` 的方法中，保持 API 层轻薄。