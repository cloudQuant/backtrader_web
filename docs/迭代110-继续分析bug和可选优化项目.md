### 背景
现有的功能已经基本实现，剩下的主要是对这些功能进行改进优化了；

### 任务
1. 寻找并发现现有系统有哪些bug
2. 发现并寻找可以优化的地方
3. 把这些地方放到这个文档上线，方便后续进行改进优化.

---

## 一、BUG 清单

### BUG-1：`backtest_enhanced.py` 中 `get_backtest_status` 存在与迭代109相同的变量遮蔽问题
- **文件**: `src/backend/app/api/backtest_enhanced.py` 第 87-93 行
- **问题**: `status = await service.get_task_status(task_id)` 将返回值赋给 `status`，遮蔽了导入的 `fastapi.status` 模块。如果 `get_task_status` 返回 `None`，第 89 行 `status.HTTP_404_NOT_FOUND` 会抛出 `AttributeError`。此外第 93 行 `status.value` 在 status 为 None 时也会报错。
- **严重程度**: 高
- **修复方案**: 将变量改名为 `task_status`，与 `backtest.py` 保持一致。

### BUG-2：`backtest_enhanced.py` 中 `get_backtest_result` 缺少用户鉴权
- **文件**: `src/backend/app/api/backtest_enhanced.py` 第 64-77 行
- **问题**: `get_result(task_id)` 调用没有传入 `user_id` 参数，任何登录用户都可以通过 `/api/v1/backtests/{task_id}` 获取其他用户的回测结果。
- **严重程度**: 高
- **修复方案**: 改为 `await service.get_result(task_id, user_id=current_user.sub)`。

### BUG-3：`backtest_enhanced.py` 中服务工厂函数没有加 `@lru_cache`
- **文件**: `src/backend/app/api/backtest_enhanced.py` 第 27-36 行
- **问题**: 迭代109已对主路由中的服务工厂加了 `@lru_cache`，但此文件中的 `get_backtest_service()`、`get_optimization_service()`、`get_report_service()` 仍是每次请求创建新实例。
- **严重程度**: 低
- **修复方案**: 添加 `from functools import lru_cache` 并对三个函数加 `@lru_cache`。

### BUG-4：`SettingsPage.vue` 修改密码功能是假的
- **文件**: `src/frontend/src/views/SettingsPage.vue` 第 107-125 行
- **问题**: `changePassword()` 函数只做了前端校验后直接弹出"密码修改成功"，**没有调用任何后端 API**。密码实际上没有被修改。
- **严重程度**: 高
- **修复方案**: 后端增加 `PUT /api/v1/auth/change-password` 接口，前端调用该接口。

### BUG-5：`SettingsPage.vue` 系统设置（主题/语言）不持久化
- **文件**: `src/frontend/src/views/SettingsPage.vue` 第 100-103 行
- **问题**: 主题和语言设置使用 `reactive` 局部状态，刷新页面即丢失，也没有实际切换主题/语言的逻辑。
- **严重程度**: 低
- **修复方案**: 存入 `localStorage` 并应用到全局样式；或者移除该配置区域避免误导用户。

### BUG-6：`live_trading_api.py` 实盘K线信号未区分多空方向
- **文件**: `src/backend/app/api/live_trading_api.py` 第 256-260 行
- **问题**: 实盘策略K线信号生成逻辑直接将 `dtopen` 标记为 `buy`、`dtclose` 标记为 `sell`，没有根据交易的 `direction`/`long` 字段区分多空。做空交易的开仓应该是 sell、平仓应该是 buy。
- **严重程度**: 中
- **修复方案**: 参照回测分析的修复，根据 `t.get("direction")` 或 `t.get("long")` 决定 open/close 信号的 type。

### BUG-7：`live_trading_api.py` 实盘K线信号价格不准确
- **文件**: `src/backend/app/api/live_trading_api.py` 第 258-260 行
- **问题**: 开仓和平仓信号都使用 `t.get("price", 0)` 即交易均价，而不是分别使用开仓日和平仓日的K线收盘价。与回测分析中的 BUG-2 同源。
- **严重程度**: 中
- **修复方案**: 构建 `kline_close_map`，信号价格优先查找K线收盘价。

### BUG-8：`LiveTradingDetailPage.vue` 使用 `v-if` 而非 `v-show` 导致图表重渲染
- **文件**: `src/frontend/src/views/LiveTradingDetailPage.vue` 第 41、52、66 行
- **问题**: 与 `BacktestResultPage.vue` 相同的问题，tab 切换使用 `v-if` 导致 ECharts 实例被销毁重建。
- **严重程度**: 低
- **修复方案**: 改为 `v-show`，与 `BacktestResultPage.vue` 保持一致。

### BUG-9：`backtest_enhanced.py` WebSocket 中 `status` 变量遮蔽
- **文件**: `src/backend/app/api/backtest_enhanced.py` 第 334 行
- **问题**: `status = await backtest_service.get_task_status(task_id)` 遮蔽了 `fastapi.status`，虽然后面没有直接使用 `status.HTTP_xxx`，但 `status` 被重复赋值为任务状态枚举，代码易混淆。
- **严重程度**: 低
- **修复方案**: 改为 `task_status`。

### BUG-10：`live_trading_api.py` 分析接口无用户归属校验
- **文件**: `src/backend/app/api/live_trading_api.py` 全文
- **问题**: 所有实盘接口虽然依赖 `get_current_user`，但 `LiveTradingManager` 的 JSON 文件是全局共享的，没有 `user_id` 字段。任何登录用户都能查看/操作其他用户创建的实盘实例。
- **严重程度**: 高（多用户环境下）
- **修复方案**: 在实例数据中增加 `user_id` 字段，查询时过滤。单用户环境可暂不修复。

### BUG-11：`DataPage.vue` CSV 导出缺少 BOM 头
- **文件**: `src/frontend/src/views/DataPage.vue` 第 119-126 行
- **问题**: 导出的 CSV 文件没有 UTF-8 BOM 头（`\uFEFF`），中文表头在 Excel 中打开会乱码。
- **严重程度**: 低
- **修复方案**: `const csv = '\uFEFF' + [headers.join(','), ...].join('\n')`。

---

## 二、可优化项

### OPT-1：`backtest_enhanced.py` 是 `backtest.py` 的几乎完全重复
- **文件**: `src/backend/app/api/backtest_enhanced.py`（382 行）、`src/backend/app/api/backtest.py`（125 行）
- **问题**: 两个文件分别注册在 `/backtest` 和 `/backtests` 路径，功能高度重叠（run、get、status、list、delete）。`backtest_enhanced.py` 额外提供了优化和报告导出，但核心 CRUD 是重复的。维护两套代码容易出现修一个漏一个。
- **建议**: 合并两个路由，将优化和报告导出端点迁移到主 `backtest.py` 或独立的 `report.py`、`optimization.py`。

### OPT-2：`PortfolioPage.vue` 一次性请求 5 个 API
- **文件**: `src/frontend/src/views/PortfolioPage.vue` 第 219-225 行
- **问题**: `loadData()` 并行请求了 overview、positions、trades、equity、allocation 五个接口。大部分数据在切换 tab 之前不需要。
- **建议**: 仅预加载 overview，其余按 tab 切换时懒加载。

### OPT-3：`OptimizationPage.vue` 轮询间隔固定 1.5 秒
- **文件**: `src/frontend/src/views/OptimizationPage.vue` 第 374-385 行
- **问题**: 优化进度轮询使用固定 1500ms 间隔。对于大规模优化（上千组合），轮询可能太频繁；对于快速优化，可能响应不够及时。
- **建议**: 使用 WebSocket 推送进度，或采用指数退避策略。

### OPT-4：`EquityCurve.vue` 金额格式化硬编码 `¥` 和 `K`
- **文件**: `src/frontend/src/components/charts/EquityCurve.vue` 第 87 行
- **问题**: Y 轴格式化为 `¥${(v / 1000).toFixed(0)}K`，当初始资金为 100 万时显示不友好，且不支持其他币种。
- **建议**: 使用动态单位选择（K/万/M），根据数值范围自动调整。

### OPT-5：`DrawdownChart.vue` 回撤值符号不一致
- **文件**: `src/frontend/src/components/charts/DrawdownChart.vue` 第 51 行
- **问题**: `d.drawdown * 100` — 但 `get_backtest_data()` 中计算回撤为 `(value - peak) / peak`，即负值。而 `parse_all_logs()` 中回撤是正值百分比。数据源不同时，回撤正负号会不一致，图表可能反转。
- **建议**: 统一回撤定义为正值（代表回撤幅度），在前端显示时统一取负。

### OPT-6：多处 ECharts 实例未处理窗口 resize
- **文件**: `src/frontend/src/views/OptimizationPage.vue`
- **问题**: 热力图、箱体图、3D 散点图的 ECharts 实例没有监听 `window.resize`，窗口大小变化时图表不会自适应。相比之下 `EquityCurve.vue` 和 `PortfolioPage.vue` 做了处理。
- **建议**: 在 `onMounted` 中添加 `window.addEventListener('resize', ...)` 并在 `onBeforeUnmount` 中移除。

### OPT-7：`LiveTradingManager` 每次操作都读写 JSON 文件
- **文件**: `src/backend/app/services/live_trading_manager.py`
- **问题**: `_load_instances()` 和 `_save_instances()` 在每个方法调用时都执行文件 I/O。`list_instances()` 调用了一次 load + 一次 save，`start_instance()` 也是。高并发下可能存在竞态条件（两个请求同时 load + save 导致数据丢失）。
- **建议**: 在内存中维护实例状态，定期或变更时持久化。使用文件锁防止竞态。

### OPT-8：`backtest_enhanced.py` WebSocket 中实例化新的 `BacktestService`
- **文件**: `src/backend/app/api/backtest_enhanced.py` 第 330 行
- **问题**: WebSocket handler 内 `backtest_service = BacktestService()` 创建了新实例，没有使用 `lru_cache` 缓存的实例。
- **建议**: 使用 `get_backtest_service()` 获取缓存实例。

### OPT-9：`StrategyPage.vue` 自定义 Markdown 渲染器功能有限
- **文件**: `src/frontend/src/views/StrategyPage.vue` 第 282-312 行
- **问题**: `renderedReadme` 使用正则手动解析 Markdown，不支持嵌套列表、链接、图片等常见语法，且存在 XSS 风险（直接 `v-html` 输出未净化的内容）。
- **建议**: 使用成熟的 Markdown 库如 `marked` + `DOMPurify` 进行安全渲染。

### OPT-10：`DataPage.vue` 查询功能直连后端但无分页
- **文件**: `src/frontend/src/views/DataPage.vue` 第 88-106 行
- **问题**: 查询半年的日K线数据一次性全部返回，如果数据量大（分钟级数据）可能导致响应缓慢和前端卡顿。
- **建议**: 添加后端分页或限制最大返回条数。

### OPT-11：`live_trading_api.py` 中 `parse_all_logs` 使用 `strategy_dir` 而非 `log_dir`
- **文件**: `src/backend/app/api/live_trading_api.py` 第 148 行
- **问题**: `parse_all_logs(strategy_dir)` 传入的是策略根目录而非日志子目录。`parse_all_logs` 内部会调用 `find_latest_log_dir` 再找子目录，但如果有多个日志目录可能取到非预期的一个。
- **建议**: 先调用 `find_latest_log_dir(strategy_dir)` 获取明确的 log_dir，再传入 `parse_all_logs`。

### OPT-12：`backtest_enhanced.py` WebSocket 进度是模拟的
- **文件**: `src/backend/app/api/backtest_enhanced.py` 第 339-346 行
- **问题**: `progress = await ws_manager.get_connection_count(task_id)` 用连接数乘以 10 模拟进度百分比，与实际回测进度无关。
- **建议**: 从实际的回测任务状态中获取进度，或者标注此端点为实验性功能。