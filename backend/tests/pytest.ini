"""
Pytest 配置

测试框架配置
"""
import pytest
import sys
from pathlib import Path

# 项目根目录
PROJECT_ROOT = Path(__file__).parent.parent
BACKEND_ROOT = Path(__file__).parent

# 添加项目根目录到 Python 路径
sys.path.insert(0, str(BACKEND_ROOT))

# 测试配置
pytest_plugins = [
    "pytest_asyncio",
    "pytest_cov",
    "pytest_mock",
]


def pytest_configure(config):
    """Pytest 配置"""
    # 标记配置
    config.addinivalue(
        "markers",
        "slow: marks tests as slow (deselect with '-m \"not slow\"')",
        "integration: marks tests as integration tests",
        "unit: marks tests as unit tests",
        "api: marks tests as API tests",
        "service: marks tests as service tests",
        "security: marks tests as security tests",
        "websocket: marks tests as websocket tests",
    )

    # 最小 Python 版本
    minversion = "3.10"
    sys_version = f"{sys.version_info.major}.{sys.version_info.minor}.{sys.version_info.micro}"
    if sys_version < minversion:
        raise ValueError(f"Python {minversion}+ required, got {sys_version}")

    # 异步模式配置
    config.option.mode_markers = "asyncio"
    config.option.asyncio_mode = "auto"

    # 测试发现
    config.addinivalue(
        "pythonpath",
        str(BACKEND_ROOT),
    )
